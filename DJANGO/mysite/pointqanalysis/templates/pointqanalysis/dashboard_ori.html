{% extends 'pointqanalysis/template_skeleton.html' %}
{% load staticfiles %}
{% block title %} Dashboard {% endblock %}


{% block container %} 
	{% if json_birdeye %}
	<div id="step1">
		<div id='left_tree' style="height: 600px">
			<h2>Network Occupancy</h2>
			<h3>Controls</h3>
			<button type="button" class="btn btn-default play">Play</button>
			<button type="button" class="btn btn-default pause">Pause</button>
			<button type="button" class="btn btn-default restart">Restart</button><br /><br />
			<div class="btn-group" data-toggle="buttons">
				<label class="btn btn-default radio_speed">
					<input type="radio" id="radio_s1" autocomplete="off" > X25
				</label>
				<label class="btn btn-default active radio_speed">
					<input type="radio" id="radio_s2" autocomplete="off" checked> X50
				</label>
				<label class="btn btn-default radio_speed">
					<input type="radio" id="radio_s3" autocomplete="off"> X100
				</label>
			</div>
			<h3>Set Time Origin</h3>
			<form class="form-inline time_origin" style="display: inline-block">
				<div class="input-group">
					<input type="text" class="form-control" id="set_origin_h" placeholder="hh" style="width:45px">
					<div class="input-group-addon">h</div>
				</div>
				<div class="input-group">
					<input type="text" class="form-control" id="set_origin_m" placeholder="mm" style="width:45px">
					<div class="input-group-addon">m</div>
				</div>
				<div class="input-group">
					<input type="text" class="form-control" id="set_origin_s" placeholder="ss" style="width:45px">
					<div class="input-group-addon">s</div>
				</div>
			</form>
			<button type="text" class="btn btn-primary set_time_origin">Set</button>

			<h3>Jump to: </h3>
			<p><b>End Time</b> = <span id='end_time'> 18h20min50s </span></p> 
			<form class="form-inline jump" style="display: inline-block">
				<div class="input-group">
					<input type="text" class="form-control" id="field_time_simu_h" placeholder="hh" style="width:45px">
					<div class="input-group-addon">h</div>
				</div>
				<div class="input-group">
					<input type="text" class="form-control" id="field_time_simu_m" placeholder="mm" style="width:45px">
					<div class="input-group-addon">m</div>
				</div>
				<div class="input-group">
					<input type="text" class="form-control" id="field_time_simu_s" placeholder="ss" style="width:45px">
					<div class="input-group-addon">s</div>
				</div>
			</form>
			<button type="text" class="btn btn-primary btn-jump">Jump</button>

			<h3>Legend: </h3>
			<p>Occupancy [%]</p>
			<img src="{% static 'pointqanalysis/images/gradient.png' %}" style="opacity: 0.8"/>
		</div>
		<div id="map-container">
			<div id="time-display"></div>
			<div id="map-canvas" style='width: 100%; height: 520px'></div>
			<div id="nanobar"></div>
		</div>
	</div>

	{% else %}
	<h2>The data hasn't been processed yet, please come back in few minutes</h2>
	{% endif %}
{% endblock %}

{% block javascript %} 
	<script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript"  src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>

	{% if json_birdeye %}
		<script type="text/javascript"  src="{% static 'pointqanalysis/js/nanobar.min.js' %}"></script>
		<script type="text/javascript"  src="http://momentjs.com/downloads/moment.min.js"></script>
		<script type="text/javascript">

			// GLOBAL VARIABLES
			var geojson = JSON.parse('{{ geojson|safe}}');
			var topjson = JSON.parse('{{ topjson|safe}}');
			var maxtimesim = parseInt({{ maxtimesim }});
			var history_json = JSON.parse('{{ json_birdeye|safe}}');
			var map; 
			var indicator;
			var ori_dest_links = [null,null];
			var static_img_marker = '{% static 'pointqanalysis/images/marker_dashboard.png' %}';
			var static_img_close = '{% static "pointqanalysis/images/close.png" %}';
			var routes;
			var dic_veh;
			var moment_origin = moment({hour: 0, minute: 0, second: 0});

			// We display the time_origin
			$('#set_origin_h').val(moment_origin.hour());
			$('#set_origin_m').val(moment_origin.minute());
			$('#set_origin_s').val(moment_origin.second());


			// variables for the nanobar
			var options = {
				bg: '#333',

				// leave target blank for global nanobar
				target: document.getElementById('nanobar'),

				// id for new nanobar
				id: 'mynano'
			};

			var nanobar = new Nanobar( options );

			nanobar.go(0);

			// sync function for the moment
			function display_moment(time){

				// We clear and replace the time on the map
				$('#time-display').empty();
				$('#time-display').append(time.format('HH:mm:ss'));

				// We display it in the jump section
				$('#field_time_simu_h').val(time.hour());
				$('#field_time_simu_m').val(time.minute());
				$('#field_time_simu_s').val(time.second());
			}

			// function to display the end_time
			function display_end_time(){
				$('#end_time').empty();
				var end_moment = moment(moment_origin).add(maxtimesim,'s');
				$('#end_time').append(end_moment.format('HH:mm:ss'));
			}

			//init end time
			display_end_time();

			function isInt(x) {
				var y = parseInt(x, 10);
				return !isNaN(y) && x == y && x.toString() == y.toString();
			}



		</script>
		<script type="text/javascript"  src="{% static 'pointqanalysis/js/dashboard.map.js' %}"></script>
		<script type="text/javascript"  src="{% static 'pointqanalysis/js/dashboard.birdeye.js' %}"></script>
		<script>
			$(function(){
				// Initialize map
				initialize();

				// Initialize  animation
				birdeye.init();

				$('.radio_speed').click(function(){
					var id = $(this).children().first().attr('id');
					
					if (id == "radio_s1") {
						birdeye.timestep = 0.2;
						birdeye.simu_time_step = 5;
					}
					else if (id == "radio_s2") {
						birdeye.timestep = 0.1;
						birdeye.simu_time_step = 5;
					}
					else if (id == "radio_s3") {
						birdeye.timestep = 0.1;
						birdeye.simu_time_step = 10;
					}
				});

				$('.play').click(function() {
					birdeye.play();
				});

				$('.pause').click(function() {
					birdeye.pause();
				});

				$('.restart').click(function() {
					birdeye.restart();
				});

				$('#field_time_simu').click(function() {
					birdeye.pause();
				});

				$('#field_time_simu').change(function() {
					// we check that the input is correct
					if ($('#field_time_simu').val() == String(parseInt($('#field_time_simu').val(),10))) {
						if (parseInt($('#field_time_simu').val()) < 0 || parseInt($('#field_time_simu').val()) > maxtimesim) {
							alert('You must provide an integer between 0 and ' + maxtimesim)
						}
						else {
							var value = parseInt($('#field_time_simu').val());
							// we approximate the value to the nearest multiple of 5
							while(value % 5 != 0){
								value += 1;
							}

							birdeye.goto(value);
						}
					}
					else {
						alert('You must provide an integer')
					}				
				});

				// SET ORIGIN TIME

				$('.time_origin').click(function(){
					birdeye.pause();
				});

				$('.set_time_origin').click(function(){
					var hour = $('#set_origin_h').val();
					var minute = $('#set_origin_m').val();
					var second = $('#set_origin_s').val();

					// we check if they are all integer
					if (isInt(hour) && isInt(minute) && isInt(second)){
						if (hour < 0 || hour > 23 || minute < 0 || minute > 59 || second < 0 || second > 59 ) {
							alert('Integer out of bound');
						}
						else {
							moment_origin = moment({'hour': hour, 'minute': minute, 'second': second});
							display_end_time();
						}
					}
					else {
						alert('You must provide integer arguments');
					}
				});

				// JUMP TO

				$('.jump').click(function(){
					birdeye.pause();
				});

				$('.btn-jump').click(function(){
					// First step, we gather the values
					var hour = $('#field_time_simu_h').val();
					var minute = $('#field_time_simu_m').val();
					var second = $('#field_time_simu_s').val();

					// Second step, we check if they are all integer within correct bonds
					if (isInt(hour) && isInt(minute) && isInt(second)){
						if (hour < 0 || hour > 23 || minute < 0 || minute > 59 || second < 0 || second > 59 ) {
							alert('Integer out of bound');
						}
						else {
							// we create a moment and determine the difference with the origin moment in seconds
							var moment_jumped = moment({'hour': hour, 'minute': minute, 'second': second});
							
							var difference = moment_jumped.diff(moment_origin, 's');

							if (difference < 0 || difference >= maxtimesim) {
								alert('The moment you entered hasn\'t been simulated');
							}
							else {
								// we approximate the value to the nearest multiple of 5
								while(difference % 5 != 0){
									difference += 1;
								}

								birdeye.goto(difference);
							}
						}
					}
				});
			});
		</script>
	{% endif %}

{% endblock %}